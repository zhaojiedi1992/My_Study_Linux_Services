防火墙
=============================================================

iptables的使用
---------------------------------------------------

.. code-block:: text 


    链操作：
        -N: new,创建新的链
        -X: delete,删除一个链
        -F: flush,清空一个链
        -P: policy,策略
        -E: rename,重名

    规则操作： 
        -A: append,追加一条规则
        -I: insert,插入一天规则
        -D: delete, 删除一条规则
        -R: replace,替换一条规则
        -Z: zero,清空计数器

    匹配规则： 
        基本匹配：
            -s: src,匹配源地址
            -d: dst,匹配目标地址
            -i: 指定数据包的流入接口
            -o: 指定数据的流出接口
        
        扩展匹配： 
            tcp:
                -p: protocol,指定协议
                --sports： 源端口
                --dports:  目标端口
                --tcp-flags: 标记
                --sync:     只允许新连接
            udp:
                --sports： 源端口
                --dports:  目标端口
            icmp:
                --icmp-type: 8ping出去，0代表进入
            
        显式扩展：
            -m state：
                NEW: 新连接
                ESTABLISHED:对一个权限的请求进行回应
                RELATED: 两个完整连接之间的相互关系
                INVALID: 无法识别的状态连接
                UNTRACKED: 未追踪的连接

            -m multiport: 
                --sports: 22,80,443 指定多个端口
                --dports: 指定多个端口
                --ports： 指定端口，不限定是入和出的端口
            
            -m iprange: 
                --src-range: 源地址范围
                --dst-range: 目标地址范围
            
            -m connlimit: 
                --connlimit-upto n: 限定并发连接数的上限
                --connlimit-above n: 限定并发连接数的下限
            
            -m limit: 
                --limit: 限制速率
                --limit-burst: 突发速率限定
            
            -m string: 
                --algo bm|kmp: 指定算法
                ! --string pattern : 给定要检查的字符串模式
                
            -m time: 
                --datestart YYYY[-MM-DD][Thh:mm:ss]: 起始日期时间
                --dateend YYYY[-MM-DD][Thh:mm:ss]: 结束日期时间
                --timestart hh:mm:ss 起始时间
                --timeend   hh:mm:ss 结束时间
                ! --monthdays： 匹配一个月中的那些天
                ! --weekdays: 匹配一周中的那些天

    处理动作： 
        --j TARGET 其中TARGET有下面几个值
        ACCEPT  接受
        DROP    丢弃
        REJECT  拒绝
        SNAT    源地址转化
        DNAT    目标地址转换
        REDIRECT 重定向
        LOG  日志

样例
----------------------------------------------------------

查看所有链

.. code-block:: bash 

    [root@centos-150 ~]#
    [root@centos-150 ~]#  iptables -nL --line-number


查看特定表

.. code-block:: bash 

    [root@centos-150 ~]# iptables -nL -t nat 

修改默认规则

.. code-block:: bash 

    [root@centos-150 ~]# iptables -t filter -P FORWARD DROP


放行特定ip特定端口访问

.. code-block:: bash 

    [root@centos-150 ~]# iptables -A INPUT -s 0/0 -d 192.168.46.1 -p tcp --dport 21 -j ACCEPT
    [root@centos-150 ~]# iptables -A OUTPUT -s 192.168.46.1 -d 0/0 -p tcp --sport 21 -j ACCEPT


只能本机ping别人，限制别人ping

.. code-block:: bash 

     [root@centos-150 ~]# iptables -A OUTPUT -p icmp --icmp-type 8 -s 192.168.168.150 -j ACCEPT
     [root@centos-150 ~]# iptables -A INPUT -p icmp --icmp-type 0 -s 0/0 -j ACCEPT 

禁止访问包含有“old”字符的页面

.. code-block:: bash 

    [root@centos-150 ~]# iptables -I OUTPUT  -s 192.168.46.7 -d 0/0  -p tcp --sport 80  -m string --algo kmp --string "old"   -j DROP


时间限定

.. code-block:: bash 

    [root@centos-150 ~]# iptables -A INPUT -d 192.168.46.7 -p tcp --dport 23 -m iprange --src-range 172.18.46.1-172.18.46.100 \
    -m time --timestart 09:00:00 --timestop 18:00:00 --weekdays 1,2,3,4,5 -j ACCEPT 

允许23端口同一个客户端小于3个并发连接

.. code-block:: bash 

    [root@centos-150 ~]# iptables -A INPUT -s 0/0 -d 192.168.46.7 -p tcp --dport 23 -m connlimit ! --connlimit-above 3 -j ACCEPT

允许22，23，80端口访问

.. code-block:: bash 

    [root@centos-150 ~]# iptables -A INPUT -s 192.168.46.0/24 -d 192.168.46.7 -p tcp -m multiport --dport 22,23,80 \
     -m state --state NEW,established -j ACCEPT

允许ftp访问

.. code-block:: bash 

    [root@centos-150 ~]# modprobe  nf_conntrack_ftp
    [root@centos-150 ~]# iptables -A INPUT -d 192.168.46.7 -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT


每个访问规则添加日志记录

.. code-block:: bash 

    [root@centos-150 ~]# iptables -I FORWARD 2 -s 10.0.0.0/24 -p tcp -m multiport --dports 80,21,22,23 \
    -m state --state NEW -j LOG --log-prefix "new conn:"

防火墙案例
--------------------------------------------------------------------------


SNAT案例
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

要求如下： 

#. 时间控制: 在1，3，5上午09：00到12：00 ,下午2：00到16：00不能访问，其他时间都可以访问
#. 网址限制: 限制huya.com视频播放和douyu.com视频播放
#. 特例控制: 对于192.168.46.1-192.168.46.4 这些ip不能有任何限制
#. snat服务： 要给局域网内部的机器提供nat功能。


详细部署图： 

.. image:: /images/secure/snat.png

.. code-block:: bash 

    # 各个主机的网关配置为防火墙的网关为192.168.46.151。
    # 启动防火墙的路由功能
    [root@centos-151 ~]# echo net.ipv4.ip_forward=1 >> /etc/sysctl.conf
    [root@centos-151 ~]# sysctl  -p
    [root@centos-151 ~]# cat /proc/sys/net/ipv4/ip_forward
    1
    # 给局域网主机启用snat服务,这里不要质疑我的为何外网ip是172的。 我这个请求还要被172.18.0.1这个防火墙snat的。

    [root@centos-151 ~]# iptables -S 
    -P INPUT ACCEPT
    -P FORWARD ACCEPT
    -P OUTPUT ACCEPT
    -A FORWARD -m iprange --src-range 192.168.46.1-192.168.46.4 -j ACCEPT
    -A FORWARD -s 192.168.46.0/24 -m string --string "huya.com" --algo bm --to 65535 -j REJECT --reject-with icmp-port-unreachable
    -A FORWARD -s 192.168.46.0/24 -m string --string "douyu.com" --algo bm --to 65535 -j REJECT --reject-with icmp-port-unreachable
    -A FORWARD -m time --timestart 01:00:00 --timestop 04:00:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T03:14:07 -j ACCEPT
    -A FORWARD -m time --timestart 06:00:00 --timestop 10:00:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T03:14:07 -j ACCEPT
    -A FORWARD -s 192.168.46.0/24 -j REJECT --reject-with icmp-port-unreachable


DNAT案例
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


firewalld-cmd的使用
---------------------------------------------------